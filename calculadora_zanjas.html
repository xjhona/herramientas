<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Zanjas de Riego - Pro</title>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Librerías para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .pattern-sand { background-color: #fce7b2; opacity: 0.8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Iconos SVG ---
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconRuler = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12.5a.5.5 0 0 1 .5-.5h21a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5H2.5a.5.5 0 0 1-.5-.5v-9z"></path><path d="M10 18v-3"></path><path d="M14 18v-3"></path><path d="M18 18v-3"></path><path d="M6 18v-3"></path></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>;
        const IconFileText = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
        const IconCalculator = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line></svg>;

        const App = () => {
            // --- Estado ---
            const availablePipes = [
                { label: '630 mm', val: 630 }, { label: '500 mm', val: 500 },
                { label: '450 mm', val: 450 }, { label: '400 mm', val: 400 },
                { label: '355 mm', val: 355 }, { label: '315 mm', val: 315 },
                { label: '250 mm', val: 250 }, { label: '200 mm', val: 200 },
                { label: '160 mm', val: 160 }, { label: '140 mm', val: 140 },
                { label: '110 mm', val: 110 }, { label: '90 mm', val: 90 },
                { label: '75 mm', val: 75 }, { label: '63 mm', val: 63 },
                { label: '1 1/2" (50mm)', val: 50 }, { label: '1" (32mm)', val: 32 },
            ];

            const [selectedPipes, setSelectedPipes] = useState([]);
            const [config, setConfig] = useState({ 
                pipeGap: 15,    // cm
                wallGap: 20,    // cm
                sandBed: 10,    // cm (Cama de Arena)
                trenchLength: 100, // metros
                trenchDepth: 1.2   // metros
            });
            
            const [results, setResults] = useState({
                widthCm: 0,
                volExcavation: 0,
                volSand: 0
            });
            
            const printRef = useRef(null);

            // --- Lógica ---
            const addPipe = (pipe) => {
                setSelectedPipes([...selectedPipes, { ...pipe, id: Date.now() + Math.random() }]);
            };

            const removePipe = (id) => {
                setSelectedPipes(selectedPipes.filter(p => p.id !== id));
            };

            const handleConfigChange = (e) => {
                const { name, value } = e.target;
                setConfig(prev => ({ ...prev, [name]: Number(value) }));
            };

            // Efecto de Cálculo
            useEffect(() => {
                if (selectedPipes.length === 0) {
                    setResults({ widthCm: 0, volExcavation: 0, volSand: 0 });
                    return;
                }

                // Ancho de Zanja
                const sumDiametersCm = selectedPipes.reduce((acc, pipe) => acc + (pipe.val / 10), 0);
                const totalPipeGaps = (selectedPipes.length - 1) * config.pipeGap;
                const totalWallGaps = config.wallGap * 2;
                const widthCm = sumDiametersCm + totalPipeGaps + totalWallGaps;
                const widthM = widthCm / 100;

                // Volúmenes
                // Volumen Excavación = Ancho * Profundidad * Largo
                const volExcavation = widthM * config.trenchDepth * config.trenchLength;
                
                // Volumen Arena = Ancho * AltoCama * Largo
                // Nota: Esto es solo la cama BASE. No incluye relleno lateral de tubería (riñones).
                const volSand = widthM * (config.sandBed / 100) * config.trenchLength;

                setResults({ widthCm, volExcavation, volSand });

            }, [selectedPipes, config]);

            // Generar PDF
            const generatePDF = async () => {
                if(!printRef.current) return;
                
                const btn = document.getElementById('btn-pdf');
                if(btn) btn.innerText = "Generando...";

                try {
                    const canvas = await html2canvas(printRef.current, { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 0, 10, pdfWidth, pdfHeight);
                    pdf.save(`calculo_zanja_${new Date().toISOString().slice(0,10)}.pdf`);
                } catch (err) {
                    alert("Error al generar PDF: " + err.message);
                } finally {
                    if(btn) btn.innerText = "Descargar PDF";
                }
            };

            // --- Componente Visual ---
            const TrenchVisualizer = () => {
                if (selectedPipes.length === 0) return (
                    <div className="h-64 w-full bg-slate-100 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center text-slate-400">
                        Agrega tuberías para ver el esquema
                    </div>
                );

                const margin = 50;
                const scaleFactor = 4;
                let currentX = config.wallGap;
                
                // Calcular posiciones
                const pipePositions = selectedPipes.map(pipe => {
                    const radius = (pipe.val / 10) / 2;
                    const cx = currentX + radius;
                    currentX += (pipe.val / 10) + config.pipeGap;
                    return { ...pipe, cx, radius };
                });

                const svgWidth = Math.max(800, results.widthCm * scaleFactor + (margin * 2));
                const svgHeight = 350;
                const toSvg = (cm) => cm * scaleFactor;
                
                // Nivel del suelo (fondo de la zanja)
                const groundY = svgHeight - 40; 
                // Altura de la cama de arena en px
                const sandHeightPx = toSvg(config.sandBed);
                // Nivel superior de la cama de arena (donde se apoyan los tubos)
                const sandTopY = groundY - sandHeightPx;

                return (
                    <div className="overflow-x-auto border rounded-lg bg-sky-50 p-4 shadow-inner">
                        <svg width={svgWidth} height={svgHeight} className="mx-auto bg-white/50 rounded">
                            <defs>
                                <pattern id="soilPattern" patternUnits="userSpaceOnUse" width="10" height="10">
                                    <path d="M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2" stroke="#d4b483" strokeWidth="1" />
                                </pattern>
                                <pattern id="sandPattern" patternUnits="userSpaceOnUse" width="4" height="4">
                                    <rect width="4" height="4" fill="#fef3c7" />
                                    <circle cx="2" cy="2" r="0.5" fill="#d97706" opacity="0.4" />
                                </pattern>
                                <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                                    <path d="M0,0 L0,6 L9,3 z" fill="#2563eb" />
                                </marker>
                            </defs>
                            
                            {/* Fondo de Tierra General */}
                            <rect x="0" y="50" width={svgWidth} height={svgHeight} fill="url(#soilPattern)" opacity="0.2" />

                            {/* Paredes Zanja */}
                            <line x1={margin} y1="50" x2={margin} y2={svgHeight} stroke="#8B4513" strokeWidth="3" />
                            <line x1={margin + toSvg(results.widthCm)} y1="50" x2={margin + toSvg(results.widthCm)} y2={svgHeight} stroke="#8B4513" strokeWidth="3" />

                            {/* Cama de Arena */}
                            <rect 
                                x={margin} 
                                y={sandTopY} 
                                width={toSvg(results.widthCm)} 
                                height={sandHeightPx} 
                                fill="url(#sandPattern)" 
                                stroke="#d97706"
                                strokeWidth="0.5"
                            />
                            {/* Etiqueta Cama Arena */}
                            <text x={margin - 5} y={groundY - (sandHeightPx/2)} textAnchor="end" fontSize="10" fill="#d97706">Arena ({config.sandBed}cm)</text>

                            {/* Suelo Base (Debajo de arena) */}
                            <rect x={margin} y={groundY} width={toSvg(results.widthCm)} height="40" fill="#e2e8f0" />

                            {/* Cota Ancho Total */}
                            <line x1={margin} y1="30" x2={margin + toSvg(results.widthCm)} y2="30" stroke="#2563eb" strokeWidth="2" markerEnd="url(#arrow)" markerStart="url(#arrow)" />
                            <text x={margin + toSvg(results.widthCm)/2} y="20" textAnchor="middle" fill="#2563eb" fontWeight="bold">Ancho: {results.widthCm.toFixed(1)} cm</text>

                            {/* Tuberías */}
                            {pipePositions.map((p) => (
                                <g key={p.id}>
                                    {/* El tubo se dibuja restando el radio desde la superficie de la arena (sandTopY) */}
                                    <circle 
                                        cx={margin + toSvg(p.cx)} 
                                        cy={sandTopY - toSvg(p.radius)} 
                                        r={toSvg(p.radius)} 
                                        fill="#f1f5f9" stroke="#334155" strokeWidth="2" 
                                    />
                                    <text x={margin + toSvg(p.cx)} y={sandTopY - toSvg(p.radius)} textAnchor="middle" dominantBaseline="middle" fontSize="10" fill="#334155" fontWeight="bold">{p.label}</text>
                                    {/* Texto Diámetro debajo de la cama de arena para no saturar */}
                                    <text x={margin + toSvg(p.cx)} y={sandTopY - toSvg(p.radius) * 2 - 10} textAnchor="middle" fontSize="10" fill="#64748b">Ø{p.val}</text>
                                </g>
                            ))}
                        </svg>
                    </div>
                );
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-6xl mx-auto space-y-6">
                        
                        <header className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
                                    <div className="text-blue-600"><IconRuler /></div>
                                    Calculadora de Zanjas Pro
                                </h1>
                                <p className="text-slate-500 mt-1 text-sm">Diseño de sección, volúmenes de obra y reporte.</p>
                            </div>
                            <button 
                                id="btn-pdf"
                                onClick={generatePDF}
                                className="mt-4 md:mt-0 flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl shadow-md transition-colors font-medium"
                            >
                                <IconFileText /> Descargar PDF
                            </button>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            
                            {/* --- COLUMNA IZQUIERDA: CONTROLES (4 cols) --- */}
                            <div className="lg:col-span-4 space-y-6">
                                {/* Selector Tubos */}
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                                    <h2 className="font-semibold text-lg mb-4 flex items-center gap-2"><div className="text-blue-500"><IconPlus /></div> Agregar Tuberías</h2>
                                    <div className="grid grid-cols-3 gap-2">
                                        {availablePipes.map((pipe) => (
                                            <button key={pipe.label} onClick={() => addPipe(pipe)} className="px-1 py-2 text-xs md:text-sm bg-slate-50 hover:bg-blue-50 hover:text-blue-600 border border-slate-200 rounded-lg transition-all text-slate-700 font-medium truncate" title={pipe.label}>
                                                {pipe.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Configuración de Sección */}
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                                    <h2 className="font-semibold text-lg mb-4 flex items-center gap-2"><div className="text-gray-500"><IconSettings /></div> Sección Transversal</h2>
                                    <div className="space-y-5">
                                        <div>
                                            <div className="flex justify-between mb-1"><label className="text-sm font-medium text-slate-600">Separación Tubos</label><span className="text-sm font-bold text-blue-600">{config.pipeGap} cm</span></div>
                                            <input type="range" min="5" max="50" step="1" name="pipeGap" value={config.pipeGap} onChange={handleConfigChange} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                        </div>
                                        <div>
                                            <div className="flex justify-between mb-1"><label className="text-sm font-medium text-slate-600">Respeto Pared</label><span className="text-sm font-bold text-blue-600">{config.wallGap} cm</span></div>
                                            <input type="range" min="10" max="60" step="1" name="wallGap" value={config.wallGap} onChange={handleConfigChange} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                        </div>
                                        <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                                            <div className="flex justify-between mb-1"><label className="text-sm font-bold text-yellow-800">Cama de Arena</label><span className="text-sm font-bold text-yellow-700">{config.sandBed} cm</span></div>
                                            <input type="range" min="0" max="30" step="5" name="sandBed" value={config.sandBed} onChange={handleConfigChange} className="w-full h-2 bg-yellow-200 rounded-lg appearance-none cursor-pointer accent-yellow-600" />
                                        </div>
                                    </div>
                                </div>

                                {/* Configuración de Obra (Volúmenes) */}
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                                    <h2 className="font-semibold text-lg mb-4 flex items-center gap-2"><div className="text-emerald-500"><IconCalculator /></div> Datos de Obra</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1">Longitud de Zanja (m)</label>
                                            <input type="number" name="trenchLength" value={config.trenchLength} onChange={handleConfigChange} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1">Profundidad Total (m)</label>
                                            <input type="number" name="trenchDepth" step="0.1" value={config.trenchDepth} onChange={handleConfigChange} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* --- COLUMNA DERECHA: REPORTE E IMPRESIÓN (8 cols) --- */}
                            <div className="lg:col-span-8 space-y-6" ref={printRef}>
                                {/* Este div 'printRef' es lo que saldrá en el PDF */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    
                                    {/* Resumen de Resultados (Header del reporte) */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        <div className="bg-blue-600 text-white p-4 rounded-xl shadow-lg">
                                            <div className="text-blue-100 text-sm font-medium">Ancho Mínimo</div>
                                            <div className="text-3xl font-bold">{results.widthCm.toFixed(1)} <span className="text-lg opacity-80">cm</span></div>
                                        </div>
                                        <div className="bg-emerald-600 text-white p-4 rounded-xl shadow-lg">
                                            <div className="text-emerald-100 text-sm font-medium">Vol. Excavación</div>
                                            <div className="text-3xl font-bold">{results.volExcavation.toFixed(2)} <span className="text-lg opacity-80">m³</span></div>
                                        </div>
                                        <div className="bg-yellow-500 text-white p-4 rounded-xl shadow-lg">
                                            <div className="text-yellow-100 text-sm font-medium">Vol. Arena (Cama)</div>
                                            <div className="text-3xl font-bold">{results.volSand.toFixed(2)} <span className="text-lg opacity-80">m³</span></div>
                                        </div>
                                    </div>

                                    {/* Gráfico */}
                                    <div className="mb-6">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="font-bold text-slate-700">Esquema de Sección</h3>
                                            {selectedPipes.length > 0 && 
                                                <button onClick={() => setSelectedPipes([])} className="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded-full flex items-center gap-1 border border-red-100" data-html2canvas-ignore="true">
                                                    <IconTrash /> Limpiar
                                                </button>
                                            }
                                        </div>
                                        <TrenchVisualizer />
                                    </div>

                                    {/* Tabla de Detalles */}
                                    <div className="border-t pt-4">
                                        <h3 className="font-semibold text-slate-700 mb-3">Detalle de Materiales</h3>
                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <p className="text-slate-500">Tuberías Seleccionadas:</p>
                                                <div className="flex flex-wrap gap-1 mt-1">
                                                    {selectedPipes.map((p, i) => (
                                                        <span key={p.id} className="bg-slate-100 text-slate-600 px-2 py-1 rounded border border-slate-200 text-xs">{p.label}</span>
                                                    ))}
                                                    {selectedPipes.length === 0 && <span className="italic text-slate-400">Ninguna</span>}
                                                </div>
                                            </div>
                                            <div className="text-right space-y-1">
                                                <p><span className="text-slate-500">Largo Total:</span> <b>{config.trenchLength} m</b></p>
                                                <p><span className="text-slate-500">Profundidad:</span> <b>{config.trenchDepth} m</b></p>
                                                <p><span className="text-slate-500">Espesor Cama Arena:</span> <b>{config.sandBed} cm</b></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>